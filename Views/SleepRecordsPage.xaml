<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             x:Class="CribSheet.Views.SleepRecordsPage"
             xmlns:viewModels="clr-namespace:CribSheet.ViewModels"
             xmlns:models="clr-namespace:CribSheet.Models"
             xmlns:converters="clr-namespace:CribSheet.Converters"
             x:DataType="viewModels:SleepRecordsViewModel"
             Title="Sleep Records"
             x:Name="sleepRecordsPage"
             SafeAreaEdges="All">
  <ContentPage.Resources>
    <ResourceDictionary>
      <converters:SleepBlockBoundsConverter x:Key="SleepBlockBoundsConverter" />
      <converters:SleepTypeColorConverter x:Key="SleepTypeColorConverter" />
    </ResourceDictionary>
  </ContentPage.Resources>

  <VerticalStackLayout Padding="10,0">
    <FlexLayout Direction="Row"
                JustifyContent="SpaceBetween"
                AlignItems="Center"
                Margin="15">
      <Button Text="Add Sleep Record"
              Command="{Binding NavigateToNewSleepCommand}"
              Margin="10" />
    </FlexLayout>

    <CollectionView ItemsSource="{Binding CalendarDays}">
      <CollectionView.Header>
        <Label Text="Sleep Calendar"
               FontSize="Medium"
               FontAttributes="Bold"
               HorizontalOptions="Center" />
      </CollectionView.Header>

      <CollectionView.ItemTemplate>
        <DataTemplate x:DataType="models:SleepCalendarDay">
          <Border Margin="10,5"
                  Padding="12">
            <VerticalStackLayout Spacing="8">

              <!-- Day header: date + total sleep -->
              <FlexLayout Direction="Row"
                          JustifyContent="SpaceBetween"
                          AlignItems="Center">
                <Label Text="{Binding Date, StringFormat='{0:dddd, MMMM d, yyyy}'}"
                       FontAttributes="Bold"
                       FontSize="Medium" />
                <Label Text="{Binding TotalSleepText, StringFormat='Total: {0}'}"
                       FontSize="Small"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
              </FlexLayout>

              <!-- Hour markers -->
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Label Text="12am" Grid.Column="0" HorizontalOptions="Start"
                       FontSize="10" TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}" />
                <Label Text="6am" Grid.Column="1" HorizontalOptions="Start"
                       FontSize="10" TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}" />
                <Label Text="12pm" Grid.Column="2" HorizontalOptions="Start"
                       FontSize="10" TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}" />
                <Label Text="6pm" Grid.Column="3" HorizontalOptions="Start"
                       FontSize="10" TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}" />
              </Grid>

              <!-- 24-hour timeline with proportional sleep blocks -->
              <Grid HeightRequest="40"
                    HorizontalOptions="Fill">
                <!-- Background track -->
                <BoxView Color="{AppThemeBinding Light=#E0E0E0, Dark=#3A3A3A}"
                         CornerRadius="6" />
                <!-- Sleep blocks layer -->
                <AbsoluteLayout HorizontalOptions="Fill"
                                VerticalOptions="Fill">
                  <BindableLayout.ItemsSource>
                    <Binding Path="Records" />
                  </BindableLayout.ItemsSource>
                  <BindableLayout.ItemTemplate>
                    <DataTemplate x:DataType="models:SleepRecord">
                      <BoxView CornerRadius="4"
                               Color="{Binding TypeOfSleep, Converter={StaticResource SleepTypeColorConverter}}"
                               AbsoluteLayout.LayoutBounds="{Binding ., Converter={StaticResource SleepBlockBoundsConverter}}"
                               AbsoluteLayout.LayoutFlags="All" />
                    </DataTemplate>
                  </BindableLayout.ItemTemplate>
                </AbsoluteLayout>
              </Grid>

              <!-- Legend -->
              <HorizontalStackLayout Spacing="16"
                                     HorizontalOptions="Center">
                <HorizontalStackLayout Spacing="5">
                  <BoxView Color="#1A237E"
                           WidthRequest="14"
                           HeightRequest="14"
                           CornerRadius="3"
                           VerticalOptions="Center" />
                  <Label Text="Night"
                         FontSize="11"
                         VerticalOptions="Center" />
                </HorizontalStackLayout>
                <HorizontalStackLayout Spacing="5">
                  <BoxView Color="#42A5F5"
                           WidthRequest="14"
                           HeightRequest="14"
                           CornerRadius="3"
                           VerticalOptions="Center" />
                  <Label Text="Nap"
                         FontSize="11"
                         VerticalOptions="Center" />
                </HorizontalStackLayout>
              </HorizontalStackLayout>

              <!-- Individual sleep records with edit/delete -->
              <VerticalStackLayout BindableLayout.ItemsSource="{Binding Records}"
                                   Spacing="4">
                <BindableLayout.ItemTemplate>
                  <DataTemplate x:DataType="models:SleepRecord">
                    <Border Padding="10,8"
                            StrokeThickness="0"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}">
                      <FlexLayout Direction="Row"
                                  JustifyContent="SpaceBetween"
                                  AlignItems="Center">
                        <VerticalStackLayout Spacing="2">
                          <HorizontalStackLayout Spacing="6">
                            <BoxView Color="{Binding TypeOfSleep, Converter={StaticResource SleepTypeColorConverter}}"
                                     WidthRequest="10"
                                     HeightRequest="10"
                                     CornerRadius="5"
                                     VerticalOptions="Center" />
                            <Label Text="{Binding TypeOfSleep}"
                                   FontSize="12"
                                   FontAttributes="Bold"
                                   VerticalOptions="Center" />
                          </HorizontalStackLayout>
                          <Label Text="{Binding StartTime, StringFormat='{0:h:mm tt}'}"
                                 FontSize="13" />
                          <Label Text="{Binding EndTime, StringFormat='â†’ {0:h:mm tt}'}"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
                          <Label Text="{Binding Duration, StringFormat='Duration: {0:h\\:mm}'}"
                                 FontSize="12"
                                 TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
                        </VerticalStackLayout>
                        <HorizontalStackLayout Spacing="5">
                          <ImageButton Source="edit.png"
                                       Command="{Binding BindingContext.EditSleepCommand, Source={x:Reference sleepRecordsPage}}"
                                       CommandParameter="{Binding .}"
                                       WidthRequest="36"
                                       HeightRequest="36"
                                       HorizontalOptions="End"
                                       VerticalOptions="Start"
                                       BackgroundColor="Transparent" />
                          <ImageButton Source="delete.png"
                                       Command="{Binding BindingContext.DeleteSleepCommand, Source={x:Reference sleepRecordsPage}}"
                                       CommandParameter="{Binding .}"
                                       WidthRequest="36"
                                       HeightRequest="36"
                                       HorizontalOptions="End"
                                       VerticalOptions="Start"
                                       BackgroundColor="Transparent" />
                        </HorizontalStackLayout>
                      </FlexLayout>
                    </Border>
                  </DataTemplate>
                </BindableLayout.ItemTemplate>
              </VerticalStackLayout>

            </VerticalStackLayout>
          </Border>
        </DataTemplate>
      </CollectionView.ItemTemplate>

      <CollectionView.EmptyView>
        <ContentView>
          <Label Text="No Sleep Records Available"
                 FontAttributes="Bold"
                 Margin="0,40,0,0"
                 HorizontalOptions="Center"
                 VerticalOptions="End" />
        </ContentView>
      </CollectionView.EmptyView>
    </CollectionView>
  </VerticalStackLayout>
</ContentPage>
